<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ãƒãƒƒãƒ—DB Pro</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªé¢¨) --- */
        :root {
            --primary: #007AFF; /* ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼(é’) */
            --bg-color: #f2f2f7; /* èƒŒæ™¯ã‚°ãƒ¬ãƒ¼ */
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #888888;
            --danger: #ff3b30;
            --success: #34c759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-bottom: 80px;
        }

        /* --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0 0 15px 0;
            font-weight: 800;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å‘¨ã‚Š */
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--text-sub);
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* ã‚¹ãƒãƒ›ã§ã‚ºãƒ¼ãƒ ã—ãªã„ã‚µã‚¤ã‚º */
            box-sizing: border-box;
            background: #fafafa;
        }
        textarea {
            height: 100px;
            font-family: monospace;
        }

        /* ãƒœã‚¿ãƒ³ */
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; margin-top: 10px; }
        .btn-small { width: auto; padding: 5px 10px; font-size: 0.8rem; }

        /* --- ãƒãƒƒãƒ—ã‚¨ãƒªã‚¢ --- */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-bottom: 15px;
            background-color: #ddd; /* èª­ã¿è¾¼ã¿å‰ã‚°ãƒ¬ãƒ¼ */
            position: relative;
        }
        
        /* åœ°å›³é€£å‹•ã‚¹ã‚¤ãƒƒãƒï¼ˆãƒãƒƒãƒ—ä¸Šã«æµ®éŠï¼‰ */
        .map-toggle-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 8px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 10;
        }
        /* ã‚¹ã‚¤ãƒƒãƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .count-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .customer-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid var(--primary); /* å·¦ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆç·š */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .c-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .c-meta { display: flex; gap: 10px; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .c-tag { background: #eee; padding: 2px 6px; border-radius: 4px; }
        .c-tel { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .c-addr { font-size: 0.85rem; color: #555; }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .accordion {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel {
            display: none;
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .show { display: block; }

        /* InfoWindowï¼ˆå¹ãå‡ºã—ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .gm-style .gm-style-iw {
            font-weight: normal;
        }
        .popup-content h3 { font-size: 1rem; margin: 0 0 5px 0; }
        .popup-btn-group { display: flex; gap: 5px; margin-top: 8px; }
        .popup-btn { 
            flex: 1; text-align: center; padding: 5px; 
            border-radius: 4px; text-decoration: none; font-size: 0.8rem; 
            background: #eee; color: #333; 
        }
        .popup-btn.route { background: var(--success); color: white; }

    </style>
</head>
<body>

<div class="container">
    <h1>é¡§å®¢ãƒãƒƒãƒ—DB Pro</h1>

    <div id="map"></div>
    <div class="map-toggle-container">
        <span>ğŸ—ºï¸ åœ°å›³é€£å‹•</span>
        <label class="switch">
            <input type="checkbox" id="syncToggle" checked>
            <span class="slider"></span>
        </label>
    </div>

    <div class="input-group">
        <input type="text" id="searchInput" placeholder="ğŸ” ãƒªã‚¹ãƒˆå†…æ¤œç´¢ (æ‹…å½“å, Rã‚³ãƒ¼ãƒ‰, åº—å, ä½æ‰€)">
    </div>

    <div class="list-header">
        <div>
            <strong>åœ°å›³ä¸­å¿ƒã‹ã‚‰è¿‘ã„é †</strong>
            <div id="totalCount" style="font-size:0.9rem; color:#666;">0 ä»¶</div>
        </div>
        <div class="count-badge" id="displayCount">è¡¨ç¤º: 0ä»¶</div>
    </div>

    <div id="customerList">
        </div>

    <div class="card">
        <div class="accordion" onclick="togglePanel()">
            <span>ï¼‹ ç™»éŒ²ãƒ»ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
            <span>â–¼</span>
        </div>
        <div class="panel" id="settingsPanel">
            <div class="input-group" style="display: flex; gap:10px;">
                <input type="password" id="apiKey" placeholder="Google Maps API Key">
                <button class="btn-success btn-small" onclick="saveApiKey()">ã‚­ãƒ¼ä¿å­˜</button>
            </div>

            <div class="input-group">
                <label>ğŸ“ æ–°è¦ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã®æ‹…å½“è€…å</label>
                <input type="text" id="repName" placeholder="ä¾‹: ä½è—¤">
            </div>
            <div class="input-group">
                <label>ãƒªã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ (5åˆ—: Rã‚³ãƒ¼ãƒ‰|æ³•äººå|åº—èˆ—å|ä½æ‰€|é›»è©±)</label>
                <textarea id="csvInput" placeholder="R001	(æ ª)ABC	å¤§å®®åº—	åŸ¼ç‰çœŒ...	090-1234-5678"></textarea>
            </div>
            
            <button class="btn-primary" onclick="processData()">ç™»éŒ²ï¼†åˆ†æã‚¹ã‚¿ãƒ¼ãƒˆ</button>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-small" style="background:#eee; color:#333;" onclick="exportData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
                <button class="btn-small" style="background:#eee; color:#333;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ã‚¹ãƒãƒ›ã§èª­è¾¼</button>
                <input type="file" id="fileInput" style="display: none;" onchange="importData(this)">
            </div>

            <button class="btn-danger" onclick="clearAllData()">ã“ã®DBã‚’å…¨å‰Šé™¤</button>
        </div>
    </div>
</div>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let map;
    let markers = [];
    let customers = []; // é¡§å®¢ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨
    const STORAGE_KEY_DATA = 'customer_db_data';
    const STORAGE_KEY_API = 'google_maps_api_key';

    // --- åˆæœŸåŒ–å‡¦ç† ---
    window.onload = function() {
        loadData();
        const apiKey = localStorage.getItem(STORAGE_KEY_API);
        if (apiKey) {
            document.getElementById('apiKey').value = apiKey;
            loadGoogleMaps(apiKey);
        } else {
            document.getElementById('map').innerHTML = '<div style="padding:20px;text-align:center;padding-top:150px;">APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';
        }
    };

    function togglePanel() {
        document.getElementById('settingsPanel').classList.toggle('show');
    }

    // --- ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
    function processData() {
        const rawText = document.getElementById('csvInput').value;
        const repName = document.getElementById('repName').value || "æ‹…å½“ãªã—";
        
        if (!rawText.trim()) return alert("ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const lines = rawText.trim().split('\n');
        let newCount = 0;

        lines.forEach(line => {
            const cols = line.split('\t'); // ã‚¿ãƒ–åŒºåˆ‡ã‚Šã‚’æƒ³å®š
            if (cols.length >= 4) { // æœ€ä½é™ ä½æ‰€ã¾ã§ã‚ã‚‹ã‹
                const customer = {
                    id: Date.now() + Math.random().toString(36),
                    rCode: cols[0] || "",
                    company: cols[1] || "",
                    shop: cols[2] || "",
                    address: cols[3] || "",
                    phone: cols[4] || "",
                    rep: repName,
                    lat: null, // å¾Œã§ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
                    lng: null
                };
                customers.push(customer);
                newCount++;
            }
        });

        saveData();
        alert(`${newCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚\n(ä½æ‰€ã‹ã‚‰ã®ãƒ”ãƒ³ç«‹ã¦ã¯APIã‚­ãƒ¼è¨­å®šå¾Œã«åœ°å›³ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰è¡Œã‚ã‚Œã¾ã™)`);
        renderList();
        if(map) geocodeMissingCoordinates(); // åœ°å›³ãŒã‚ã‚Œã°åº§æ¨™å–å¾—é–‹å§‹
    }

    // --- Google Maps é–¢é€£ ---
    function saveApiKey() {
        const key = document.getElementById('apiKey').value;
        if (!key) return;
        localStorage.setItem(STORAGE_KEY_API, key);
        alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
        location.reload();
    }

    function loadGoogleMaps(key) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap&libraries=geometry`;
        script.async = true;
        document.head.appendChild(script);
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 35.681236, lng: 139.767125 }, // æ±äº¬é§…
            zoom: 13,
            streetViewControl: false,
            mapTypeControl: false
        });

        // ãƒãƒƒãƒ—ãŒå‹•ã„ãŸã‚‰ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆé€£å‹•ONã®å ´åˆï¼‰
        map.addListener('idle', () => {
            if (document.getElementById('syncToggle').checked) {
                renderList();
            }
        });

        // æœªå–å¾—ã®åº§æ¨™ãŒã‚ã‚Œã°å–å¾—
        geocodeMissingCoordinates();
        // ãƒ”ãƒ³ã‚’è¡¨ç¤º
        updateMarkers();
        renderList();
    }

    // ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼šãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆè€ƒæ…®ãªã—ï¼‰
    async function geocodeMissingCoordinates() {
        const geocoder = new google.maps.Geocoder();
        let changed = false;

        for (let c of customers) {
            if (!c.lat && c.address) {
                try {
                    const result = await new Promise((resolve, reject) => {
                        geocoder.geocode({ address: c.address }, (results, status) => {
                            if (status === 'OK') resolve(results[0].geometry.location);
                            else reject(status);
                        });
                    });
                    c.lat = result.lat();
                    c.lng = result.lng();
                    changed = true;
                    // APIåˆ¶é™ã‚’é¿ã‘ã‚‹ãŸã‚å°‘ã—å¾…æ©Ÿ
                    await new Promise(r => setTimeout(r, 300));
                } catch (e) {
                    console.log("Geocode error:", c.address, e);
                }
            }
        }
        if (changed) {
            saveData();
            updateMarkers();
            renderList();
        }
    }

    function updateMarkers() {
        // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
        markers.forEach(m => m.setMap(null));
        markers = [];

        customers.forEach(c => {
            if (c.lat && c.lng) {
                const marker = new google.maps.Marker({
                    position: { lat: c.lat, lng: c.lng },
                    map: map,
                    title: c.shop
                });

                // å¹ãå‡ºã—
                const content = `
                    <div class="popup-content">
                        <h3>${c.company} ${c.shop}</h3>
                        <div style="font-size:0.8rem; color:#666;">
                            æ‹…å½“: ${c.rep}<br>
                            R: ${c.rCode}<br>
                            <a href="tel:${c.phone}">${c.phone}</a><br>
                            ${c.address}
                        </div>
                        <div class="popup-btn-group">
                            <button class="popup-btn" onclick="alert('ç·¨é›†æ©Ÿèƒ½')">âœ ç·¨é›†</button>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(c.address)}" target="_blank" class="popup-btn route">ğŸš¶ ãƒ«ãƒ¼ãƒˆ</a>
                        </div>
                    </div>
                `;
                
                const infowindow = new google.maps.InfoWindow({ content: content });
                marker.addListener("click", () => {
                    infowindow.open(map, marker);
                });
                markers.push(marker);
            }
        });
    }

    // --- ãƒªã‚¹ãƒˆè¡¨ç¤º ---
    function renderList() {
        const listEl = document.getElementById('customerList');
        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        const isSync = document.getElementById('syncToggle').checked;
        
        listEl.innerHTML = "";

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filtered = customers.filter(c => {
            // æ–‡å­—åˆ—æ¤œç´¢
            const textMatch = (c.company + c.shop + c.address + c.rep + c.rCode).toLowerCase().includes(searchVal);
            if (!textMatch) return false;

            // åœ°å›³ç¯„å›²å†…æ¤œç´¢ï¼ˆé€£å‹•ONã‹ã¤åº§æ¨™ãŒã‚ã‚‹å ´åˆï¼‰
            if (isSync && map && c.lat && c.lng) {
                const bounds = map.getBounds();
                if (bounds && !bounds.contains({ lat: c.lat, lng: c.lng })) {
                    return false;
                }
            }
            return true;
        });

        // åœ°å›³ä¸­å¿ƒã‹ã‚‰ã®è·é›¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆåœ°å›³ãŒã‚ã‚‹å ´åˆï¼‰
        if (map) {
            const center = map.getCenter();
            filtered.sort((a, b) => {
                if (!a.lat || !b.lat) return 0;
                const distA = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(a.lat, a.lng));
                const distB = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(b.lat, b.lng));
                return distA - distB;
            });
        }

        // ä»¶æ•°è¡¨ç¤º
        document.getElementById('totalCount').innerText = `${customers.length} ä»¶`;
        document.getElementById('displayCount').innerText = `è¡¨ç¤º: ${filtered.length}ä»¶`;

        // è¡¨ç¤ºï¼ˆæœ€å¤§100ä»¶ï¼‰
        filtered.slice(0, 100).forEach(c => {
            const html = `
                <div class="customer-card">
                    <div class="c-name">
                        <span style="color:${varColor(c.rep)}">â—</span> 
                        ${c.company}<br>${c.shop}
                    </div>
                    <div class="c-meta">
                        <span class="c-tag">${c.rCode}</span>
                        <span>${c.rep}</span>
                    </div>
                    <div class="c-tel">
                        ğŸ“ <a href="tel:${c.phone}" style="color:inherit;text-decoration:none;">${c.phone}</a>
                    </div>
                    <div class="c-addr">${c.address}</div>
                </div>
            `;
            listEl.innerHTML += html;
        });
    }

    // æ‹…å½“è€…ã”ã¨ã«ä½•ã¨ãªãè‰²ã‚’å¤‰ãˆã‚‹ç”¨
    function varColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        return '#' + "00000".substring(0, 6 - c.length) + c;
    }

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­è¾¼ ---
    function saveData() {
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(customers));
    }
    function loadData() {
        const data = localStorage.getItem(STORAGE_KEY_DATA);
        if (data) customers = JSON.parse(data);
    }
    function clearAllData() {
        if(confirm("æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem(STORAGE_KEY_DATA);
            customers = [];
            renderList();
            updateMarkers();
        }
    }
    function exportData() {
        const blob = new Blob([JSON.stringify(customers)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'customer_db_backup.json';
        a.click();
    }
    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(Array.isArray(json)) {
                    customers = json;
                    saveData();
                    alert("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
                    location.reload();
                }
            } catch(err) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
            }
        };
        reader.readAsText(file);
    }

    // æ¤œç´¢çª“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('searchInput').addEventListener('input', renderList);
    document.getElementById('syncToggle').addEventListener('change', renderList);

</script>
</body>
</html>
